<!DOCTYPE html>
<html>
<head>
    <title>Live Captions</title>
</head>
<body>
<h2>Live Captions</h2>
<div id="captions"></div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();

// Capture microphone audio
navigator.mediaDevices.getUserMedia({ audio: true })
.then(stream => {
    const audioContext = new AudioContext();
    const source = audioContext.createMediaStreamSource(stream);
    const processor = audioContext.createScriptProcessor(4096, 1, 1);

    source.connect(processor);
    processor.connect(audioContext.destination);

    processor.onaudioprocess = (e) => {
        const input = e.inputBuffer.getChannelData(0);
        let buffer = new ArrayBuffer(input.length * 2);
        let view = new DataView(buffer);
        for (let i = 0; i < input.length; i++) {
            let s = Math.max(-1, Math.min(1, input[i]));
            view.setInt16(i*2, s < 0 ? s*0x8000 : s*0x7FFF, true);
        }
        socket.emit('audio_chunk', buffer);
    };
});

socket.on('transcript', text => {
    document.getElementById('captions').innerText = text;
});
</script>
</body>
</html>
